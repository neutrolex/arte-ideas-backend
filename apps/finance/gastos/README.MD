#  APIS-DATAS-BACKEND: Documentaci贸n y Gu铆a de Uso

Este documento detalla la arquitectura Multi-Tenant del proyecto y el uso del M贸dulo de Finanzas (`apps.finance`), confirmando la estabilidad del c贸digo base y la seguridad de los datos.

---

## 1. Configuraci贸n e Instalaci贸n

El proyecto utiliza una arquitectura de servicios robusta (JWT, Redis, Celery) y `django-tenants`.

### 1.1 Dependencias

* **Instalaci贸n** (con entorno virtual activo):
    ```bash
    pip install -r requirements.txt
    ```

### 1.2 Estructura Modular de Finanzas

La l贸gica de la aplicaci贸n se movi贸 a una subcarpeta para mayor orden. Los archivos en la ra铆z (`finance/`) act煤an como **NDICES** que apuntan a la l贸gica en `finance/gastos/`.

| Archivo | Contenido (C贸digo ndice) |
| :--- | :--- |
| `apps/finance/models.py` | `from .gastos.models import *` |
| `apps/finance/views.py` | `from .gastos.views import *` |
| `apps/finance/serializers.py` | `from .gastos.serializers import *` |
| `apps/finance/urls.py` | `path('', include('apps.finance.gastos.urls')),` |

### 1.3 Puesta en Marcha

1.  **Migraciones:**
    ```bash
    python manage.py migrate
    ```
2.  **Crear Superusuario:** (Obligatorio para Login)
    ```bash
    python manage.py createsuperuser
    ```
3.  **Iniciar Servidor:**
    ```bash
    python manage.py runserver
    ```

---

## 2. Arquitectura Multi-Tenant (CORE)

Esta arquitectura asegura que los datos del Tenant A (Empresa) nunca sean visibles para el Tenant B, incluso si acceden con un token v谩lido.

### Componentes Clave

| Archivo | Clase | Funci贸n en Seguridad |
| :--- | :--- | :--- |
| `core/viewsets.py` | **TenantViewSet** | **Filtra Autom谩ticamente** los listados (GET) por el `request.user.tenant`. |
| `core/middleware.py` | **TenantMiddleware** | Lee el Header `X-Tenant-ID` y asigna el Tenant al `request` para su verificaci贸n. |
| `core/permissions.py` | **TenantPermission** | Detiene peticiones (403 Forbidden) si el `X-Tenant-ID` no coincide con el Tenant del usuario logueado. |

---

## 3. M贸dulo: Gastos y Presupuestos (`/api/finance/`)

### 3.1 Endpoints y L贸gica de Negocio

El m贸dulo de finanzas se accede en `/api/finance/`. Los tests confirmaron la funcionalidad de los ViewSets y la l贸gica de negocio.

| Funcionalidad | M茅todo | URL Completa | L贸gica Probada con xito |
| :--- | :--- | :--- | :--- |
| **Login** | `POST` | `/api/core/auth/login/` | **Token V谩lido (200 OK)** y credenciales activas. |
| **Creaci贸n** | `POST` | `/api/finance/categories/` | **201 Created** al inyectar `tenant_id` y pasar la restricci贸n `unique_together`. |
| **L贸gica** | `POST` | `/api/finance/services/` | **201 Created**. Confirma que el Serializer acepta **`camelCase`** (`tipoServicio`, `fechaVencimiento`). |
| **Resumen** | `GET` | `/api/finance/summary/` | **200 OK**. Confirma que la vista agrega correctamente los montos (ej., `servicios_pendientes`). |
| **Edici贸n** | `PATCH` | `/api/finance/services/{id}/` | **200 OK**. El cambio de monto se reflej贸 correctamente en la base de datos y en el resumen. |

### 3.2 Prueba Cr铆tica de Aislamiento (Seguridad)

* **Test:** Intentar `GET /api/finance/summary/` con un `X-Tenant-ID` incorrecto (ej., `99`).
* **Resultado Verificado:** **`403 Forbidden`**.
* **Conclusi贸n:** La seguridad Multi-Tenant es robusta.

---

##  4. Gu铆a de Postman (Procedimiento Operativo)

Para usar cualquier endpoint de Finanzas, es obligatorio seguir esta secuencia:

### 4.1 Login

* **URL:** `http://127.0.0.1:8000/api/core/auth/login/`
* **Resultado:** Copiar el valor del token **`access`**.

### 4.2 Configuraci贸n de Headers (隆Esenciales!)

Estos dos headers deben acompa帽ar **TODAS** las peticiones de Finanzas (CRUD):

| Header | Valor | Prop贸sito |
| :--- | :--- | :--- |
| **`Authorization`** | `Bearer <Token_Access_JWT>` | Autenticaci贸n de la sesi贸n. |
| **`X-Tenant-ID`** | `<ID del Tenant>` | Acceso a los datos de la empresa correcta. |

### 4.3 Ejemplo de Creaci贸n (Formato JSON)

```json
{
  "codigo": "SRV-ALQ-01",
  "tipoServicio": "Alquiler",
  "proveedor": "Inmobiliaria XYZ",
  "monto": "850.00",
  "fechaVencimiento": "2025-12-01",
  "periodo": "Noviembre 2025",
  "estado": "Pendiente",
  "categoria": 1
}
```